# æ•´ç†åçš„ç‰ˆæœ¬
# ==============================================================================
# 0. å‡†å¤‡å·¥ä½œ (Setup)
# ==============================================================================
# æ¸…ç©ºç¯å¢ƒ (å¯é€‰ï¼Œä¿æŒå¹²å‡€)
rm(list = ls())
gc()

# åŠ è½½å¿…è¦çš„åŒ…
library(Seurat)
library(tidyverse)

# ...ç„¶åä¸‹é¢å†æ¥æˆ‘åˆšæ‰å‘ç»™ä½ çš„é‚£ä¸‰æ®µä»£ç ...
# ==============================================================================
# 1. è¯»å–æ•°æ® (Read Data)
# ==============================================================================

# ä½¿ç”¨ ReadMtx è¯»å– 10x æ ¼å¼çš„ä¸‰ä»¶å¥—æ–‡ä»¶
# mtx = è¡¨è¾¾é‡çŸ©é˜µ(æ•°å­—), cells = ç»†èƒID, features = åŸºå› å
raw_counts <- ReadMtx(
  mtx = "01_project_GSE141259/00_data_raw/GSE141259_WholeLung_rawcounts.mtx.gz",
  cells = "01_project_GSE141259/00_data_raw/GSE141259_WholeLung_barcodes.txt.gz",
  features = "01_project_GSE141259/00_data_raw/GSE141259_WholeLung_genes.txt.gz",
  feature.column = 1  # å…³é”®ä¿®æ­£ï¼šå‘Šè¯‰RåŸºå› ååœ¨ç¬¬1åˆ— (é»˜è®¤æ‰¾ç¬¬2åˆ—ä¼šæŠ¥é”™)
)

# ==============================================================================
# 2. åˆ›å»ºå¯¹è±¡ä¸åˆç­› (Create Object & QC)
# ==============================================================================

# æŠŠçŸ©é˜µè£…è¿› Seurat å¯¹è±¡è¿™ä¸ªâ€œæ”¶çº³ç®±â€é‡Œ
strunz_obj <- CreateSeuratObject(
  counts = raw_counts,
  project = "Strunz_Lung",
  min.cells = 3,       # è¿‡æ»¤åŸºå› ï¼šå¦‚æœä¸€ä¸ªåŸºå› åœ¨å°‘äº3ä¸ªç»†èƒé‡Œè¡¨è¾¾ï¼Œè§†ä¸ºå™ªéŸ³æ‰”æ‰
  min.features = 200   # è¿‡æ»¤ç»†èƒï¼šå¦‚æœä¸€ä¸ªç»†èƒæµ‹åˆ°çš„åŸºå› å°‘äº200ä¸ªï¼Œè§†ä¸ºåƒåœ¾/ç¢ç‰‡æ‰”æ‰
)

# å†…å­˜æ¸…ç†ï¼šæŠŠåˆšæ‰é‚£ä¸€å¤§ç›†åŸå§‹æ•°æ®å€’æ‰ï¼Œåªä¿ç•™è£…ç®±åçš„å¯¹è±¡
rm(raw_counts)
gc()

# æŠ½æ · (ä¸ºäº†ç»ƒä¹ æ—¶ä¸å¡é¡¿ï¼ŒçœŸå®è·‘æ•°æ®æ—¶å¯è·³è¿‡è¿™ä¸€æ­¥)
set.seed(123) # è®¾ç½®éšæœºç§å­ï¼Œä¿è¯æ¯æ¬¡æŠ½çš„äººéƒ½ä¸€æ ·
small_obj <- subset(strunz_obj, cells = sample(Cells(strunz_obj), 5000))
# ==============================================================================
# 3. æ ‡å‡†å¤„ç†æµç¨‹ (Standard Pipeline)
# ==============================================================================

small_obj <- small_obj %>%
  
  # A. æ ‡å‡†åŒ– (Normalization)
  # ç›®çš„ï¼šæ¶ˆé™¤æµ‹åºæ·±åº¦çš„å½±å“ (æŠŠå¤§å®¶æ‹‰åˆ°åŒä¸€èµ·è·‘çº¿)
  # åŸç†ï¼šLogNormalize (æ€»æ•°å½’ä¸€åŒ–åå–å¯¹æ•°)
  NormalizeData() %>%
  
  # B. æ‰¾é«˜å˜åŸºå›  (Feature Selection)
  # ç›®çš„ï¼šæŒ‘å‡ºæœ€èƒ½åŒºåˆ†ç»†èƒç±»å‹çš„2000ä¸ªâ€œç‰¹å¾åŸºå› â€ (å¦‚ Emr1, Col1a1)
  # å¿½ç•¥é‚£äº›æ‰€æœ‰ç»†èƒéƒ½ä¸€æ ·çš„â€œç®¡å®¶åŸºå› â€
  FindVariableFeatures() %>%
  
  # C. å½’ä¸€åŒ– (Scaling)
  # ç›®çš„ï¼šæŠŠæ•°æ®è½¬æ¢æˆ Z-score (å‡å€¼ä¸º0ï¼Œæ–¹å·®ä¸º1)
  # ä½œç”¨ï¼šé˜²æ­¢é«˜è¡¨è¾¾åŸºå› (å¦‚èƒ¶åŸè›‹ç™½)æƒé‡è¿‡å¤§ï¼Œæ©ç›–äº†å…¶ä»–åŸºå› 
  ScaleData() %>%
  
  # D. é™ç»´ PCA (Linear Dimensionality Reduction)
  # ç›®çš„ï¼šæŠŠ2000ä¸ªåŸºå› çš„å¤æ‚å…³ç³»ï¼Œå‹ç¼©æˆ50ä¸ªä¸»æˆåˆ†(PC)
  # ä½œç”¨ï¼šæç‚¼æ ¸å¿ƒç‰¹å¾ï¼Œå»é™¤å™ªéŸ³
  RunPCA() %>%
  
  # E. é™ç»´ UMAP (Non-linear Dimensionality Reduction)
  # ç›®çš„ï¼šæŠŠ50ä¸ªPCå‹ç¼©æˆ2Dåæ ‡(x,y)ï¼Œä¸ºäº†ç”»é‚£å¼ æ¼‚äº®çš„æ•£ç‚¹å›¾
  # dims = 1:15 æ„æ€æ˜¯ç”¨å‰15ä¸ªä¸»æˆåˆ†æ¥ç”»å›¾ (é€šå¸¸å¤Ÿç”¨äº†)
  RunUMAP(dims = 1:15) %>%
  
  # F. æ‰¾é‚»å±… (Neighbors)
  # ç›®çš„ï¼šåœ¨æ•°å­¦ç©ºé—´é‡Œç®—ç®—è°å’Œè°ç¦»å¾—è¿‘ï¼Œæ„å»ºç¤¾äº¤ç½‘ç»œ
  FindNeighbors(dims = 1:15) %>%
  
  # G. èšç±» (Clustering)
  # ç›®çš„ï¼šæŠŠæŠ±å›¢çš„é‚»å±…åœˆèµ·æ¥ï¼Œè´´ä¸Š 0,1,2,3 çš„æ ‡ç­¾
  # resolution = 0.5 æ˜¯åˆ†è¾¨ç‡ï¼šæ•°å€¼è¶Šå¤§ï¼Œåˆ†å¾—è¶Šç»†(ç¾¤è¶Šå¤š)
  FindClusters(resolution = 0.5)
# ==============================================================================
# 4. å¯è§†åŒ– (Visualization) - ç»ˆæå®Œæ•´ç‰ˆ
# ==============================================================================

print("ğŸ¨ æ­£åœ¨ç»˜åˆ¶ä¸‰å¥—æ ¸å¿ƒå›¾è¡¨...")

# ------------------------------------------------------------------------------
# å›¾ A: åŸºç¡€åœ°å›¾ (Cluster Map)
# ä½œç”¨: å¯¹ç…§æŸ¥çœ‹ Cluster ç¼–å· (0, 1, 2...)
# ------------------------------------------------------------------------------
p1_clusters <- DimPlot(small_obj, label = TRUE, label.size = 5) + 
  ggtitle("1. Cluster Map (Who is where?)")

# ------------------------------------------------------------------------------
# å›¾ B: èº«ä»½é‰´å®šå›¾ (Identity FeaturePlots) - ä½ è¦çš„â€œè“å›¾â€ï¼
# ä½œç”¨: ç›´è§‚å±•ç¤º AMã€æˆçº¤ç»´ã€è¡€ç®¡åˆ†åˆ«åœ¨å“ª
# ------------------------------------------------------------------------------
# è¿™é‡Œçš„é€»è¾‘æ˜¯: èƒŒæ™¯æ˜¯ç°çš„(ä¸è¡¨è¾¾)ï¼Œè“è‰²çš„ç‚¹è¶Šæ·±ä»£è¡¨è¡¨è¾¾è¶Šé«˜
p2_identity <- FeaturePlot(small_obj, 
                           features = c("Emr1", "Marco",    # AM (ä¸»è§’)
                                        "Col1a1", "Pecam1"), # å¹²æ‰°é¡¹
                           ncol = 2) # æ’æˆ 2åˆ— x 2è¡Œ

# ------------------------------------------------------------------------------
# å›¾ C: é¶ç‚¹éªŒè¯å›¾ (Target FeaturePlots)
# ä½œç”¨: çœ‹çœ‹ä½ çš„ Fpr1 åˆ°åº•æ˜¯ä¸æ˜¯åªäº®åœ¨ AM çš„åœ°ç›˜ä¸Šï¼Ÿ
# ------------------------------------------------------------------------------
p3_targets <- FeaturePlot(small_obj, 
                          features = c("Fpr1", "Fpr2", "Ccr2", "Ccr5"),
                          ncol = 2,
                          # å¢åŠ ä¸€ä¸ªå°æŠ€å·§: è°ƒæ•´é¢œè‰² (æµ…ç° -> çº¢)ï¼Œçº¢è‰²å¯èƒ½æ¯”è“è‰²æ›´æ˜¾çœ¼
                          cols = c("lightgrey", "red")) 

# ------------------------------------------------------------------------------
# å›¾ D: é‚£ä¸ªè¶…çº§æ°”æ³¡å›¾ (Super DotPlot) - ç»Ÿè®¡å­¦æ±‡æ€»
# ------------------------------------------------------------------------------
features_list <- c("Emr1", "Marco", "Col1a1", "Pecam1", # èº«ä»½
                   "Fpr1", "Fpr2", "Ccr1", "Ccr2", "Ccr5") # é¶ç‚¹

p4_dotplot <- DotPlot(small_obj, features = features_list) + 
  RotatedAxis() + 
  scale_color_gradient(low = "grey95", high = "red") +
  ggtitle("4. Statistical Summary")

# ------------------------------------------------------------------------------
# 5. ä¿å­˜æˆ˜æœ (Save)
# ------------------------------------------------------------------------------
print("ğŸ’¾ æ­£åœ¨ä¿å­˜...")

ggsave("01_project_GSE141259/04_output_plots/Map_Clusters.png", plot = p1_clusters)
ggsave("01_project_GSE141259/04_output_plots/Map_Identity_Spatial.png", plot = p2_identity, width = 10, height = 8)
ggsave("01_project_GSE141259/04_output_plots/Map_Targets_Spatial.png", plot = p3_targets, width = 10, height = 8)
ggsave("01_project_GSE141259/04_output_plots/Stats_DotPlot.png", plot = p4_dotplot, width = 12, height = 6)

print("ğŸ‰ å®Œç¾ï¼åœ°å›¾(Map)ã€è“å›¾(FeaturePlot)ã€æ°”æ³¡å›¾(DotPlot) å…¨éƒ¨é›†é½ï¼")


# å¯è§†åŒ–ä½œå›¾åˆ†æ­¥éª¤è¿›è¡Œ
print("ğŸ¨ 2. æ­£åœ¨ç»˜åˆ¶å•åŸºå› è¡¨è¾¾ UMAP (FeaturePlots) - é˜²å¼¹ç‰ˆ...")

# --- 2.1 èº«ä»½é‰´å®šç»„ (Identity) ---
identity_genes <- c("Emr1", "Marco", "Col1a1", "Pecam1")

# ä¿®æ­£ï¼šå»æ‰äº†é‚£ä¸ªå¯¼è‡´æŠ¥é”™çš„ plot_annotation
p2_identity <- FeaturePlot(small_obj, features = identity_genes, ncol = 2) 

print(p2_identity)
ggsave("01_project_GSE141259/04_output_plots/2_Identity_FeaturePlots.png", plot = p2_identity, width = 10, height = 8)


# --- 2.2 é¶ç‚¹å…¨å®¶æ¡¶ç»„ (Targets: Fpr + Ccr) ---
target_genes <- c("Fpr1", "Fpr2", 
                  "Ccr1", "Ccr2", "Ccr3", "Ccr4", "Ccr5")

# ä¿®æ­£ï¼šå»æ‰äº†é‚£ä¸ªå¯¼è‡´æŠ¥é”™çš„ plot_annotation
p2_targets <- FeaturePlot(small_obj, features = target_genes, ncol = 3) 

print(p2_targets)
ggsave("01_project_GSE141259/04_output_plots/2_Targets_FeaturePlots.png", plot = p2_targets, width = 12, height = 12)

print("âœ… ç¬¬äºŒéƒ¨åˆ† FeaturePlot æå®šï¼ç»ä¸æŠ¥é”™ï¼")
print("ğŸ“Š 3. æ­£åœ¨ç»˜åˆ¶æ±‡æ€»ç‚¹å›¾ (DotPlot) - æœ€ç»ˆç»Ÿè®¡ç¯‡...")

# ==============================================================================
# å®šä¹‰åŸºå› åˆ—è¡¨ (å…¨å®¶æ¡¶)
# ==============================================================================
# æˆ‘ä»¬æŒ‰é€»è¾‘æ’ä¸ªåºï¼Œè¿™æ ·ç”»å‡ºæ¥çš„å›¾å¥½çœ‹
all_genes_list <- c(
  # 1. èº«ä»½åŒº (å®šåæ ‡)
  "Emr1", "Marco",    # AM ä¸»è§’
  "Col1a1", "Pecam1", # å¹²æ‰°é¡¹
  
  # 2. FPR å®¶æ— (ç»†èŒé›·è¾¾)
  "Fpr1", "Fpr2", 
  
  # 3. CCR å®¶æ— (è¶‹åŒ–å—ä½“å…¨å®¶æ¡¶)
  # æŒ‰æ•°å­—é¡ºåºæ’å¥½
  "Ccr1", "Ccr2", "Ccr3", "Ccr4", "Ccr5"
)

# ==============================================================================
# ç»˜å›¾ (DotPlot)
# ==============================================================================
# scale_color_gradient: è®¾å®šé¢œè‰²ï¼Œgrey95æ˜¯æµ…ç°(ä½è¡¨è¾¾)ï¼Œredæ˜¯çº¢(é«˜è¡¨è¾¾)
p3_dotplot <- DotPlot(small_obj, features = all_genes_list) + 
  RotatedAxis() + 
  scale_color_gradient(low = "grey95", high = "red") +
  ggtitle("Comprehensive DotPlot: Identity + FPRs + CCRs")

# æ˜¾ç¤ºå›¾ç‰‡ (Review)
print(p3_dotplot)

# ==============================================================================
# ä¿å­˜ (Save)
# ==============================================================================
ggsave("01_project_GSE141259/04_output_plots/3_Final_DotPlot.png", plot = p3_dotplot, width = 12, height = 6)

print("ğŸ‰ å…¨éƒ¨æå®šï¼Map (åœ°å›¾), Blueprints (è“å›¾), Bubbles (æ°”æ³¡) å…¨éƒ¨é›†é½ï¼")
print("ğŸ“‚ å¿«å» 04_output_plots æ–‡ä»¶å¤¹æ£€é˜…ä½ çš„æˆ˜åˆ©å“ï¼")


print("ğŸ•µï¸â€â™€ï¸ å¼€å¯ç›²ç›’æ¨¡å¼ï¼æ­£åœ¨å¯»æ‰¾ AM çš„ç‹¬å®¶ç§˜ç±...")

# ==============================================================================
# å¯»æ‰¾ AM (Cluster 1) çš„ç‰¹å¼‚æ€§ Marker
# ==============================================================================

# FindMarkers æ˜¯ Seurat æœ€å¼ºå¤§çš„åŠŸèƒ½ä¹‹ä¸€
# ident.1 = 1  ->  æˆ‘ä»¬è¦æ‰¾ Cluster 1 (AM)
# min.pct = 0.25 -> åªçœ‹é‚£äº›è‡³å°‘åœ¨ 25% çš„ AM é‡Œè¡¨è¾¾çš„åŸºå›  (è¿‡æ»¤æ‰å™ªéŸ³)
# only.pos = TRUE -> åªçœ‹â€œé«˜è¡¨è¾¾â€çš„ï¼Œä¸çœ‹â€œä½è¡¨è¾¾â€çš„

am_markers <- FindMarkers(small_obj, ident.1 = 1, min.pct = 0.25, only.pos = TRUE)

# ==============================================================================
# æ•´ç†æ’è¡Œæ¦œ (Top 10)
# ==============================================================================
# æˆ‘ä»¬æŒ‰ avg_log2FC (å€æ•°å˜åŒ–) æ’åºï¼Œçœ‹çœ‹è°æ˜¯é‚£ä¸ªâ€œæœ€é“çš„ä»”â€
top10_am <- am_markers %>%
  arrange(desc(avg_log2FC)) %>% # ä»é«˜åˆ°ä½æ’
  head(10) # åªçœ‹å‰ 10 å

print("ğŸ† AM é‡Œçš„ Top 10 é«˜è¡¨è¾¾åŸºå› æ˜¯ï¼š")
print(top10_am)

# ==============================================================================
# æŠŠå‰ 10 åå­˜ä¸‹æ¥ï¼Œæˆ–è€…ç”»ä¸ªå›¾çœ‹çœ‹
# ==============================================================================
# æˆ‘ä»¬æŠŠè¿™äº›è‡ªåŠ¨æ‰¾å‡ºæ¥çš„ Top åŸºå› ç”»ä¸ªæ°”æ³¡å›¾
# rownames(top10_am) å°±æ˜¯é‚£ 10 ä¸ªåŸºå› çš„åå­—
p_discovery <- DotPlot(small_obj, features = rownames(top10_am)) + 
  RotatedAxis() +
  ggtitle("Top 10 Genes Defining AM (Unbiased Discovery)")

print(p_discovery)
ggsave("01_project_GSE141259/04_output_plots/AM_Top10_Discovery.png", plot = p_discovery, width = 12, height = 6)
